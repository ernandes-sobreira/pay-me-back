<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Racha ‚Äî Divis√£o de Contas (Moss v2)</title>
  <meta name="theme-color" content="#0b1410"/>
  <style>
    :root{
      --bg:#0b1410;
      --card:#0f1d16;
      --text:#eef7f0;
      --muted:#b8cbbb;
      --line:rgba(255,255,255,.12);
      --shadow:0 12px 30px rgba(0,0,0,.40);
      --r:16px;

      --moss:#4b7a4b;
      --gold:#d4b46a;
      --red:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 650px at 12% -10%, rgba(75,122,75,.22), transparent 55%),
        radial-gradient(900px 650px at 95% 0%, rgba(212,180,106,.16), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px 14px 40px}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:20;
      padding:12px 0 10px;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,20,16,.86), rgba(11,20,16,.46));
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: conic-gradient(from 210deg, var(--moss), var(--gold), var(--moss), var(--gold), var(--moss));
      box-shadow: 0 10px 26px rgba(0,0,0,.45);
    }
    h1{font-size:16px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .grid{display:grid;grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:12px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    input, select{
      width:100%;
      border:1px solid var(--line);
      background: rgba(18,37,27,.75);
      color:var(--text);
      border-radius: 12px;
      padding:11px 12px;
      outline:none;
    }
    input::placeholder{color:rgba(238,247,240,.55)}
    input[type="date"]{padding:10px 12px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: 12px;
      padding:11px 12px;
      font-weight:900;
      cursor:pointer;
      transition:.15s transform,.15s opacity;
      user-select:none;
      white-space:nowrap;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(75,122,75,.34), rgba(212,180,106,.20));
      border-color: rgba(212,180,106,.35);
    }
    .btn.good{
      background: linear-gradient(135deg, rgba(75,122,75,.42), rgba(212,180,106,.10));
      border-color: rgba(75,122,75,.55);
    }
    .btn.bad{
      background: linear-gradient(135deg, rgba(239,68,68,.22), rgba(212,180,106,.08));
      border-color: rgba(239,68,68,.38);
    }
    .btn.ghost{background: transparent}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .tab{
      padding:9px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);cursor:pointer;font-weight:1000;font-size:12px;
    }
    .tab.active{border-color:rgba(212,180,106,.55); background: rgba(212,180,106,.14)}
    .hide{display:none}

    .hr{height:1px;background:var(--line);margin:12px 0}
    .tiny{font-size:12px;color:var(--muted);line-height:1.45}

    .members{
      display:flex; flex-wrap:wrap; gap:10px;
      border:1px solid var(--line);
      background: rgba(18,37,27,.55);
      border-radius: 14px;
      padding:10px;
    }
    .member{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding:8px 10px;
      font-size:12px;
    }
    .member input[type="checkbox"]{width:16px;height:16px}
    .member .w{width:62px;padding:6px 8px;border-radius:10px;font-weight:1000}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px 6px;text-align:left;font-size:13px;vertical-align:top}
    th{color:var(--muted);font-size:12px;font-weight:1000}
    .t-actions{display:flex;gap:8px;justify-content:flex-end}
    .mini{
      padding:7px 10px;border-radius:10px;font-size:12px;font-weight:1000;
      background: rgba(255,255,255,.06); border:1px solid var(--line); cursor:pointer;
    }

    .badge{
      display:inline-flex; align-items:center;
      padding:4px 8px; border-radius:999px; font-size:12px; font-weight:1000;
      border:1px solid rgba(212,180,106,.35);
      background: rgba(212,180,106,.10);
      color: var(--text);
    }

    /* Aviso fixo perto do salvar */
    .alert{
      border:1px solid rgba(239,68,68,.45);
      background: rgba(239,68,68,.10);
      color: #ffd6d6;
      border-radius: 12px;
      padding:10px 12px;
      font-size:12px;
      font-weight:900;
      display:none;
      margin-top:10px;
    }
    .invalid{
      border-color: rgba(239,68,68,.65) !important;
      box-shadow: 0 0 0 3px rgba(239,68,68,.18);
    }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; z-index:50;
      background: rgba(18,37,27,.96);
      border:1px solid rgba(212,180,106,.28);
      color:var(--text);
      padding:10px 12px; border-radius: 12px;
      box-shadow: var(--shadow);
      font-size:13px;
      opacity:0; pointer-events:none; transition:.2s opacity, .2s transform;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px)}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Racha ‚Äî Divis√£o de Contas</h1>
        <div class="sub">Tema musgo / dinheiro ‚Ä¢ Compartilh√°vel por link ‚Ä¢ Offline</div>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn primary" id="btnShare" type="button">Compartilhar link</button>
      <button class="btn" id="btnExport" type="button">Exportar</button>
      <button class="btn" id="btnImport" type="button">Importar</button>
      <button class="btn bad" id="btnReset" type="button">Resetar</button>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <div style="flex:1.2">
        <label>Nome do grupo</label>
        <input id="groupName" placeholder="Ex.: Viagem ‚Ä¢ Airbnb ‚Ä¢ Churrasco" autocomplete="off"/>
      </div>
      <div>
        <label>Moeda</label>
        <select id="currency">
          <option value="R$">R$ (Real)</option>
          <option value="‚Ç¨">‚Ç¨ (Euro)</option>
          <option value="$">$ (D√≥lar)</option>
        </select>
      </div>
      <div>
        <label>Modo</label>
        <select id="mode">
          <option value="edit">Edit√°vel</option>
          <option value="view">Somente leitura (no link)</option>
        </select>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="despesas" type="button">Despesas</button>
        <button class="tab" data-tab="pessoas" type="button">Pessoas</button>
        <button class="tab" data-tab="resumo" type="button">Resumo</button>
      </div>

      <!-- DESPESAS -->
      <div id="tab-despesas">

        <!-- DEIXEI A DESCRI√á√ÉO AQUI (PERTO DO SALVAR) -->
        <div class="row">
          <div style="flex:1.2">
            <label>Descri√ß√£o da despesa *</label>
            <input id="expDesc" placeholder="Ex.: Jantar, Mercado, Uber" autocomplete="off"/>
          </div>
          <div style="flex:.7">
            <label>Data</label>
            <input id="expDate" type="date"/>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:.9">
            <label>Quem pagou</label>
            <select id="expPayer"></select>
          </div>
          <div style="flex:.6">
            <label>Valor</label>
            <input id="expAmount" inputmode="decimal" placeholder="Ex.: 125,00"/>
          </div>
          <div style="flex:.8">
            <label>Divis√£o</label>
            <select id="splitType">
              <option value="equal">Igual</option>
              <option value="weights">Por pesos</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Participantes</label>
          <div class="members" id="participants"></div>
          <div class="tiny" style="margin-top:8px">
            ‚ÄúPor pesos‚Äù: coloque cotas (ex.: quem consumiu mais = 2, quem consumiu menos = 1).
          </div>
        </div>

        <div id="alert" class="alert"></div>

        <div class="row" style="margin-top:12px">
          <div style="flex:1"></div>
          <div style="flex:.8;display:flex;gap:10px;justify-content:flex-end">
            <button class="btn ghost" id="btnClearExp" type="button">Limpar</button>
            <button class="btn good" id="btnSaveExp" type="button">Salvar</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tiny" id="emptyExpenses" style="margin:6px 0 10px">Nenhuma despesa ainda.</div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Data</th><th>Descri√ß√£o</th><th>Pagou</th><th>Valor</th><th style="text-align:right">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="expensesTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- PESSOAS -->
      <div id="tab-pessoas" class="hide">
        <div class="row">
          <div>
            <label>Adicionar pessoa</label>
            <input id="personName" placeholder="Ex.: Ernandes, Claumir, √Åurea" autocomplete="off"/>
          </div>
          <div style="flex:.55">
            <button class="btn good" id="btnAddPerson" type="button">Adicionar</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="tiny" id="emptyPeople">Nenhuma pessoa cadastrada.</div>
        <div id="peopleList"></div>
      </div>

      <!-- RESUMO -->
      <div id="tab-resumo" class="hide">
        <div class="tiny">Abra depois ‚Äî primeiro salve 1 despesa üòâ</div>
      </div>
    </div>

    <div class="card">
      <div class="tiny">
        <b>Pra salvar:</b> preencha <b>Descri√ß√£o da despesa</b> (agora est√° aqui em cima), valor, e clique <b>Salvar</b>.
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function $(id){ return document.getElementById(id); }
  const LS_KEY = "racha_moss_v2";
  const toastEl = $("toast");
  const alertEl = $("alert");

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"), 1600);
  }
  function showAlert(msg){
    alertEl.textContent = msg;
    alertEl.style.display = msg ? "block" : "none";
  }
  function today(){ return new Date().toISOString().slice(0,10); }

  function toCents(v){
    const s = String(v ?? "").trim().replace(/\./g,"").replace(",",".");
    const n = Number(s);
    if(!Number.isFinite(n)) return null;
    return Math.round(n * 100);
  }
  function money(cur, cents){
    const sign = cents < 0 ? "-" : "";
    const abs = Math.abs(cents);
    const whole = Math.floor(abs/100);
    const frac = String(abs%100).padStart(2,"0");
    const wholeStr = whole.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return sign + cur + " " + wholeStr + "," + frac;
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  const state = {
    groupName: "Meu grupo",
    currency: "R$",
    mode: "edit",
    people: [],
    expenses: [],
    editingExpenseId: null
  };

  function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function loadLocal(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return false;
    try{ Object.assign(state, JSON.parse(raw)); return true; }catch{ return false; }
  }

  function setTab(name){
    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
    $("tab-despesas").classList.toggle("hide", name!=="despesas");
    $("tab-pessoas").classList.toggle("hide", name!=="pessoas");
    $("tab-resumo").classList.toggle("hide", name!=="resumo");
  }
  document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click", ()=>setTab(t.dataset.tab)));

  function renderPayerOptions(){
    const sel = $("expPayer");
    sel.innerHTML = "";
    if(!state.people.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Adicione pessoas primeiro";
      sel.appendChild(opt);
      return;
    }
    state.people.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
  }

  function ensureParticipantsDraft(ex){
    const map = new Map((ex.participants||[]).map(pp=>[pp.personId, pp]));
    ex.participants = state.people.map(p=>{
      const prev = map.get(p.id);
      return { personId:p.id, included: prev ? !!prev.included : true, weight: (prev && prev.weight!=null) ? prev.weight : 1 };
    });
  }

  let draftExpense = null;
  function getDraftExpense(){
    const ex = draftExpense ? deepClone(draftExpense) : {
      id: state.editingExpenseId || uid(),
      desc: $("expDesc").value.trim(),
      date: $("expDate").value || "",
      payerId: $("expPayer").value || "",
      amountCents: toCents($("expAmount").value),
      splitType: $("splitType").value,
      participants: []
    };
    ex.desc = $("expDesc").value.trim();
    ex.date = $("expDate").value || "";
    ex.payerId = $("expPayer").value || "";
    ex.amountCents = toCents($("expAmount").value);
    ex.splitType = $("splitType").value;
    ensureParticipantsDraft(ex);
    return ex;
  }
  function setDraftExpense(ex){ draftExpense = deepClone(ex); }

  function renderParticipants(){
    const box = $("participants");
    box.innerHTML = "";
    if(!state.people.length){
      box.innerHTML = `<div class="tiny">V√° em <b>Pessoas</b> e adicione quem participa.</div>`;
      return;
    }

    const ex = getDraftExpense();
    setDraftExpense(ex);
    const split = ex.splitType;

    ex.participants.forEach(pp=>{
      const person = state.people.find(p=>p.id===pp.personId);
      const chip = document.createElement("div");
      chip.className = "member";
      chip.innerHTML = `
        <input type="checkbox" ${pp.included ? "checked":""} data-inc="${pp.personId}"/>
        <span>${escapeHtml(person?.name || "?")}</span>
        ${split==="weights" ? `<input class="w" type="number" min="0" step="1" value="${pp.weight ?? 1}" data-w="${pp.personId}"/>` : ""}
      `;
      box.appendChild(chip);
    });

    box.querySelectorAll("[data-inc]").forEach(ch=>{
      ch.addEventListener("change", ()=>{
        const ex2 = getDraftExpense();
        const pid = ch.getAttribute("data-inc");
        const pp = ex2.participants.find(x=>x.personId===pid);
        if(pp) pp.included = ch.checked;
        setDraftExpense(ex2);
      });
    });

    box.querySelectorAll("[data-w]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const ex2 = getDraftExpense();
        const pid = inp.getAttribute("data-w");
        const pp = ex2.participants.find(x=>x.personId===pid);
        const n = Number(inp.value);
        pp.weight = Number.isFinite(n) ? Math.max(0, Math.round(n)) : 1;
        setDraftExpense(ex2);
      });
    });
  }

  function renderExpenses(){
    const tbody = $("expensesTbody");
    const empty = $("emptyExpenses");
    tbody.innerHTML = "";

    if(!state.expenses.length){
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    const peopleMap = new Map(state.people.map(p=>[p.id,p.name]));
    const rows = deepClone(state.expenses).sort((a,b)=> (b.date||"").localeCompare(a.date||""));

    rows.forEach(ex=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(ex.date || "‚Äî")}</td>
        <td>${escapeHtml(ex.desc || "‚Äî")}</td>
        <td>${escapeHtml(peopleMap.get(ex.payerId) || "‚Äî")}</td>
        <td><span class="badge">${money(state.currency, ex.amountCents || 0)}</span></td>
        <td style="text-align:right">
          <button class="mini" type="button" data-del="${ex.id}">Excluir</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        if(state.mode==="view"){ showToast("Somente leitura."); return; }
        const id = b.getAttribute("data-del");
        state.expenses = state.expenses.filter(x=>x.id!==id);
        saveLocal();
        renderExpenses();
        showToast("Removido.");
      });
    });
  }

  function renderPeople(){
    const box = $("peopleList");
    const empty = $("emptyPeople");
    box.innerHTML = "";
    if(!state.people.length){ empty.style.display="block"; return; }
    empty.style.display="none";

    state.people.forEach(p=>{
      const item = document.createElement("div");
      item.className = "card";
      item.style.margin = "10px 0";
      item.style.background = "rgba(255,255,255,.03)";
      item.innerHTML = `
        <div class="row">
          <div style="flex:1.2">
            <label>Nome</label>
            <input value="${escapeHtml(p.name)}" data-person-name="${p.id}"/>
          </div>
          <div style="flex:.55">
            <button class="btn bad" type="button" data-del-person="${p.id}">Excluir</button>
          </div>
        </div>
      `;
      box.appendChild(item);
    });

    box.querySelectorAll("[data-person-name]").forEach(inp=>{
      inp.addEventListener("input", (e)=>{
        if(state.mode==="view"){ showToast("Somente leitura."); return; }
        const id = e.target.getAttribute("data-person-name");
        const person = state.people.find(x=>x.id===id);
        if(person){
          person.name = e.target.value.trim() || "Sem nome";
          saveLocal();
          renderPayerOptions();
          renderParticipants();
          renderExpenses();
        }
      });
    });

    box.querySelectorAll("[data-del-person]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(state.mode==="view"){ showToast("Somente leitura."); return; }
        const id = btn.getAttribute("data-del-person");
        state.people = state.people.filter(p=>p.id!==id);
        state.expenses.forEach(ex=>{
          ex.participants = (ex.participants||[]).filter(pp=>pp.personId!==id);
          if(ex.payerId===id) ex.payerId = state.people[0]?.id || "";
        });
        saveLocal();
        renderAll();
        showToast("Pessoa removida.");
      });
    });
  }

  function clearInvalid(){
    $("expDesc").classList.remove("invalid");
    $("expAmount").classList.remove("invalid");
    showAlert("");
  }

  function validate(ex){
    clearInvalid();
    if(!state.people.length){
      showAlert("‚ö†Ô∏è Adicione pessoas primeiro (aba Pessoas).");
      return false;
    }
    if(!ex.desc){
      $("expDesc").classList.add("invalid");
      showAlert("‚ö†Ô∏è Falta a DESCRI√á√ÉO DA DESPESA (ex.: Jantar).");
      $("expDesc").focus();
      return false;
    }
    if(!ex.date){
      showAlert("‚ö†Ô∏è Falta a data.");
      return false;
    }
    if(ex.amountCents==null || ex.amountCents<=0){
      $("expAmount").classList.add("invalid");
      showAlert("‚ö†Ô∏è Valor inv√°lido (use 125,00).");
      $("expAmount").focus();
      return false;
    }
    const included = ex.participants.filter(p=>p.included);
    if(!included.length){
      showAlert("‚ö†Ô∏è Selecione pelo menos 1 participante.");
      return false;
    }
    if(ex.splitType==="weights"){
      const sumW = included.reduce((s,p)=> s + (Number(p.weight)||0), 0);
      if(sumW<=0){
        showAlert("‚ö†Ô∏è Em 'pesos', some pesos > 0.");
        return false;
      }
    }
    return true;
  }

  // top actions
  $("btnShare").addEventListener("click", async ()=>{
    const payload = {groupName:state.groupName,currency:state.currency,people:state.people,expenses:state.expenses};
    const data = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    const params = new URLSearchParams();
    params.set("data", data);
    params.set("mode", "view");
    const link = location.origin + location.pathname + "#" + params.toString();

    try{
      await navigator.clipboard.writeText(link);
      showToast("Link copiado!");
    }catch{
      prompt("Copie o link:", link);
    }
  });

  $("btnExport").addEventListener("click", ()=>{
    const payload = {groupName:state.groupName, currency:state.currency, people:state.people, expenses:state.expenses};
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = ("racha_" + (state.groupName||"grupo").replace(/\s+/g,"_") + ".json");
    a.click();
    URL.revokeObjectURL(a.href);
    showToast("Exportado.");
  });

  $("btnImport").addEventListener("click", ()=>{
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async ()=>{
      const file = input.files && input.files[0];
      if(!file) return;
      try{
        const txt = await file.text();
        const obj = JSON.parse(txt);
        state.groupName = obj.groupName ?? state.groupName;
        state.currency  = obj.currency ?? state.currency;
        state.people    = Array.isArray(obj.people) ? obj.people : [];
        state.expenses  = Array.isArray(obj.expenses) ? obj.expenses : [];
        state.mode = "edit";
        saveLocal();
        renderAll();
        showToast("Importado.");
      }catch{
        showToast("Arquivo inv√°lido.");
      }
    };
    input.click();
  });

  $("btnReset").addEventListener("click", ()=>{
    if(!confirm("Resetar tudo?")) return;
    localStorage.removeItem(LS_KEY);
    location.hash = "";
    location.reload();
  });

  $("mode").addEventListener("change", ()=>{
    state.mode = $("mode").value;
    saveLocal();
    renderAll();
    showToast(state.mode==="view" ? "Somente leitura." : "Edit√°vel.");
  });

  $("groupName").addEventListener("input", ()=>{
    state.groupName = $("groupName").value.trim() || "Meu grupo";
    saveLocal();
  });
  $("currency").addEventListener("change", ()=>{
    state.currency = $("currency").value;
    saveLocal();
    renderAll();
  });

  $("splitType").addEventListener("change", renderParticipants);
  $("expDesc").addEventListener("input", clearInvalid);
  $("expAmount").addEventListener("input", clearInvalid);

  $("btnClearExp").addEventListener("click", ()=>{
    $("expDesc").value = "";
    $("expAmount").value = "";
    $("splitType").value = "equal";
    $("expDate").value = today();
    clearInvalid();
    renderParticipants();
    showToast("Limpo.");
  });

  $("btnSaveExp").addEventListener("click", ()=>{
    if(state.mode==="view"){ showToast("Somente leitura."); return; }

    const ex = getDraftExpense();
    if(!validate(ex)) return;

    state.expenses.push({
      id: uid(),
      desc: ex.desc,
      date: ex.date,
      payerId: ex.payerId || state.people[0]?.id || "",
      amountCents: ex.amountCents,
      splitType: ex.splitType,
      participants: ex.participants
    });

    saveLocal();
    renderExpenses();
    showToast("SALVO ‚úÖ");
  });

  $("btnAddPerson").addEventListener("click", ()=>{
    if(state.mode==="view"){ showToast("Somente leitura."); return; }
    const name = $("personName").value.trim();
    if(!name) return showToast("Digite um nome.");
    const id = uid();
    state.people.push({id, name});
    $("personName").value = "";
    saveLocal();
    renderAll();
    showToast("Pessoa adicionada.");
  });

  function applyModeLock(){
    const lock = state.mode === "view";
    ["groupName","currency","expDesc","expDate","expPayer","expAmount","splitType","personName"].forEach(id=>$(id).disabled = lock);
    ["btnAddPerson","btnSaveExp","btnClearExp"].forEach(id=>$(id).disabled = lock);
    document.querySelectorAll("[data-inc],[data-w]").forEach(el=>el.disabled = lock);
  }

  function renderAll(){
    $("groupName").value = state.groupName || "Meu grupo";
    $("currency").value = state.currency || "R$";
    $("mode").value = state.mode || "edit";
    if(!$("expDate").value) $("expDate").value = today();

    renderPeople();
    renderPayerOptions();
    if(state.people.length && !$("expPayer").value) $("expPayer").value = state.people[0].id;

    renderParticipants();
    renderExpenses();
    applyModeLock();
  }

  // init
  loadLocal();

  // demo (se vazio)
  if(!state.people.length){
    state.groupName = "Exemplo";
    state.currency = "R$";
    state.people = [
      {id: uid(), name:"Ernandes"},
      {id: uid(), name:"Claumir"},
      {id: uid(), name:"√Åurea"},
      {id: uid(), name:"Ana Paula"},
    ];
    saveLocal();
  }

  $("expDate").value = today();
  renderAll();
})();
</script>
</body>
</html>
