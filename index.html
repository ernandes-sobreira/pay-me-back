<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Racha — Divisão de Contas (claro)</title>
  <meta name="theme-color" content="#0b1220"/>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1730;
      --card2:#101a33;
      --text:#e9efff;
      --muted:#a9b7d6;
      --line:rgba(255,255,255,.12);
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --r:16px;

      --blue:#60a5fa;
      --green:#22c55e;
      --orange:#f97316;
      --red:#ef4444;
      --purple:#a78bfa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 650px at 10% -10%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(900px 650px at 95% 0%, rgba(167,139,250,.20), transparent 55%),
        radial-gradient(900px 700px at 40% 110%, rgba(34,197,94,.16), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px 14px 40px}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:20;
      padding:12px 0 10px;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,18,32,.85), rgba(11,18,32,.45));
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: conic-gradient(from 210deg, var(--blue), var(--purple), var(--green), var(--orange), var(--blue));
      box-shadow: 0 10px 26px rgba(0,0,0,.45);
    }
    h1{font-size:16px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .grid{display:grid;grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:12px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    input, select{
      width:100%;
      border:1px solid var(--line);
      background: rgba(15,23,48,.75);
      color:var(--text);
      border-radius: 12px;
      padding:11px 12px;
      outline:none;
    }
    input[type="date"]{padding:10px 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: 12px;
      padding:11px 12px;
      font-weight:800;
      cursor:pointer;
      transition:.15s transform,.15s opacity;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background: linear-gradient(135deg, rgba(96,165,250,.30), rgba(167,139,250,.20)); border-color: rgba(96,165,250,.35)}
    .btn.good{background: linear-gradient(135deg, rgba(34,197,94,.26), rgba(96,165,250,.12)); border-color: rgba(34,197,94,.35)}
    .btn.bad{background: linear-gradient(135deg, rgba(239,68,68,.22), rgba(167,139,250,.08)); border-color: rgba(239,68,68,.38)}
    .btn.ghost{background: transparent}

    .top-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .tab{
      padding:9px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);cursor:pointer;font-weight:900;font-size:12px;
    }
    .tab.active{border-color:rgba(96,165,250,.50); background: rgba(96,165,250,.18)}
    .hide{display:none}

    .hr{height:1px;background:var(--line);margin:12px 0}
    .tiny{font-size:12px;color:var(--muted);line-height:1.45}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px 6px;text-align:left;font-size:13px;vertical-align:top}
    th{color:var(--muted);font-size:12px;font-weight:900}
    .t-actions{display:flex;gap:8px;justify-content:flex-end}
    .mini{
      padding:7px 10px;border-radius:10px;font-size:12px;font-weight:900;
      background: rgba(255,255,255,.06); border:1px solid var(--line); cursor:pointer;
    }
    .badge{
      display:inline-flex; align-items:center;
      padding:4px 8px; border-radius:999px; font-size:12px; font-weight:900;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
    }
    .pos{color:#a7f3d0;border-color: rgba(34,197,94,.35)}
    .neg{color:#fecaca;border-color: rgba(239,68,68,.35)}
    .zero{color:var(--muted)}

    .members{
      display:flex; flex-wrap:wrap; gap:10px;
      border:1px solid var(--line);
      background: rgba(15,23,48,.55);
      border-radius: 14px;
      padding:10px;
    }
    .member{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding:8px 10px;
      font-size:12px;
    }
    .member input[type="checkbox"]{width:16px;height:16px}
    .member .w{
      width:62px;
      padding:6px 8px;
      border-radius:10px;
      font-weight:900;
    }

    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:560px){.kpi{grid-template-columns:1fr}}
    .kpi .box{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:12px;
      background: rgba(255,255,255,.04);
    }
    .kpi .v{font-size:18px;font-weight:1000}
    .kpi .l{font-size:12px;color:var(--muted);margin-top:2px}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; z-index:50;
      background: rgba(15,23,48,.95);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px; border-radius: 12px;
      box-shadow: var(--shadow);
      font-size:13px;
      opacity:0; pointer-events:none; transition:.2s opacity, .2s transform;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px)}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Racha — Divisão de Contas</h1>
        <div class="sub">Claro • Leve • Compartilhável por link • Offline</div>
      </div>
    </div>

    <div class="top-actions">
      <button class="btn primary" id="btnShare">Compartilhar link</button>
      <button class="btn" id="btnExport">Exportar</button>
      <button class="btn" id="btnImport">Importar</button>
      <button class="btn bad" id="btnReset">Resetar</button>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <div style="flex:1.2">
        <label>Nome do grupo</label>
        <input id="groupName" placeholder="Ex.: Airbnb, Viagem, Churrasco"/>
      </div>
      <div>
        <label>Moeda</label>
        <select id="currency">
          <option value="R$">R$</option>
          <option value="€">€</option>
          <option value="$">$</option>
        </select>
      </div>
      <div>
        <label>Modo</label>
        <select id="mode">
          <option value="edit">Editável</option>
          <option value="view">Somente leitura (no link)</option>
        </select>
      </div>
    </div>
    <div class="tiny" style="margin-top:10px">
      Se abrir um link que alguém te mandou, ele carrega o grupo automaticamente.
      Em “Somente leitura”, o app não deixa editar — mas você pode Exportar e fazer uma cópia.
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="despesas" type="button">Despesas</button>
        <button class="tab" data-tab="pessoas" type="button">Pessoas</button>
        <button class="tab" data-tab="resumo" type="button">Resumo</button>
      </div>

      <!-- DESPESAS -->
      <div id="tab-despesas">
        <div class="row">
          <div>
            <label>Descrição</label>
            <input id="expDesc" placeholder="Ex.: Mercado, Uber, Jantar"/>
          </div>
          <div style="flex:.6">
            <label>Data</label>
            <input id="expDate" type="date"/>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:.9">
            <label>Quem pagou</label>
            <select id="expPayer"></select>
          </div>
          <div style="flex:.6">
            <label>Valor</label>
            <input id="expAmount" inputmode="decimal" placeholder="Ex.: 125,90"/>
          </div>
          <div style="flex:.8">
            <label>Divisão</label>
            <select id="splitType">
              <option value="equal">Igual</option>
              <option value="weights">Por pesos</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Participantes</label>
          <div class="members" id="participants"></div>
          <div class="tiny" style="margin-top:8px">
            “Por pesos”: coloque cotas (ex.: quem consumiu mais = 2, quem consumiu menos = 1).
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div style="flex:1"></div>
          <div style="flex:.6;display:flex;gap:10px;justify-content:flex-end">
            <button class="btn ghost" id="btnClearExp" type="button">Limpar</button>
            <button class="btn good" id="btnSaveExp" type="button">Salvar</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tiny" id="emptyExpenses" style="margin:6px 0 10px">Nenhuma despesa ainda.</div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Data</th><th>Descrição</th><th>Pagou</th><th>Valor</th><th style="text-align:right">Ações</th>
              </tr>
            </thead>
            <tbody id="expensesTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- PESSOAS -->
      <div id="tab-pessoas" class="hide">
        <div class="row">
          <div>
            <label>Adicionar pessoa</label>
            <input id="personName" placeholder="Ex.: Ernandes, Claumir, Áurea"/>
          </div>
          <div style="flex:.55">
            <button class="btn good" id="btnAddPerson" type="button">Adicionar</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="tiny" id="emptyPeople">Nenhuma pessoa cadastrada.</div>
        <div id="peopleList"></div>
      </div>

      <!-- RESUMO -->
      <div id="tab-resumo" class="hide">
        <div class="kpi">
          <div class="box"><div class="v" id="kpiTotal">—</div><div class="l">Total</div></div>
          <div class="box"><div class="v" id="kpiN">—</div><div class="l">Pessoas</div></div>
          <div class="box"><div class="v" id="kpiE">—</div><div class="l">Despesas</div></div>
        </div>

        <div class="hr"></div>
        <h3 style="margin:0 0 8px 0;font-size:14px">Saldos</h3>
        <div id="balances"></div>

        <div class="hr"></div>
        <h3 style="margin:0 0 8px 0;font-size:14px">Quem paga pra quem</h3>
        <div class="tiny" style="margin-bottom:10px">Sugestão com poucas transferências para zerar tudo.</div>
        <div id="settlement"></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0;font-size:14px">Fluxo simples</h3>
      <div class="tiny">
        1) Vá em <b>Pessoas</b> e adicione todo mundo.<br/>
        2) Registre despesas (quem pagou, valor, participantes).<br/>
        3) Veja <b>Resumo</b> e use “Quem paga pra quem”.<br/>
        4) Clique em <b>Compartilhar link</b> e mande no grupo.
      </div>
      <div class="hr"></div>
      <div class="tiny">
        Se quiser ultra-claro: use sempre <b>Igual</b>. Use <b>Pesos</b> só quando alguém consumiu mais/menos.
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  // -------- Helpers (sem structuredClone) --------
  function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function $(id){ return document.getElementById(id); }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  const LS_KEY = "racha_app_clear_v1";
  const toastEl = $("toast");
  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"), 1700);
  }

  // -------- Money --------
  function toCents(v){
    const s = String(v ?? "").trim().replace(/\./g,"").replace(",",".");
    const n = Number(s);
    if (!Number.isFinite(n)) return null;
    return Math.round(n * 100);
  }
  function money(cents){
    const cur = state.currency;
    const sign = cents < 0 ? "-" : "";
    const abs = Math.abs(cents);
    const whole = Math.floor(abs / 100);
    const frac = String(abs % 100).padStart(2,"0");
    const wholeStr = whole.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return sign + cur + " " + wholeStr + "," + frac;
  }
  function centsToInput(cents){
    const abs = Math.abs(cents);
    const whole = Math.floor(abs/100);
    const frac = String(abs%100).padStart(2,"0");
    return whole + "," + frac;
  }

  // -------- State --------
  const state = {
    groupName: "Meu grupo",
    currency: "R$",
    mode: "edit", // edit|view
    people: [],
    expenses: [],
    editingExpenseId: null
  };

  function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function loadLocal(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return false;
    try{ Object.assign(state, JSON.parse(raw)); return true; }catch{ return false; }
  }

  // -------- Share via hash (base64) --------
  function encodeData(obj){
    const json = JSON.stringify(obj);
    return btoa(unescape(encodeURIComponent(json)));
  }
  function decodeData(b64){
    const json = decodeURIComponent(escape(atob(b64)));
    return JSON.parse(json);
  }
  function loadFromHashIfAny(){
    const h = location.hash ? location.hash.slice(1) : "";
    if(!h) return false;
    const params = new URLSearchParams(h);
    const data = params.get("data");
    const mode = params.get("mode");
    if(!data) return false;
    try{
      const obj = decodeData(data);
      state.groupName = obj.groupName ?? state.groupName;
      state.currency  = obj.currency ?? state.currency;
      state.people    = Array.isArray(obj.people) ? obj.people : [];
      state.expenses  = Array.isArray(obj.expenses) ? obj.expenses : [];
      state.mode      = (mode === "view") ? "view" : "edit";
      state.editingExpenseId = null;
      saveLocal();
      return true;
    }catch(e){
      console.warn(e);
      return false;
    }
  }
  function makeShareLink(viewOnly){
    const payload = {
      groupName: state.groupName,
      currency: state.currency,
      people: state.people,
      expenses: state.expenses
    };
    const data = encodeData(payload);
    const params = new URLSearchParams();
    params.set("data", data);
    params.set("mode", viewOnly ? "view" : "edit");
    return location.origin + location.pathname + "#" + params.toString();
  }
  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch{
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      const ok = document.execCommand("copy");
      ta.remove();
      return ok;
    }
  }

  // -------- Tabs --------
  function setTab(name){
    document.querySelectorAll(".tab").forEach(t=>{
      t.classList.toggle("active", t.dataset.tab === name);
    });
    $("tab-despesas").classList.toggle("hide", name !== "despesas");
    $("tab-pessoas").classList.toggle("hide", name !== "pessoas");
    $("tab-resumo").classList.toggle("hide", name !== "resumo");
  }
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=> setTab(t.dataset.tab));
  });

  // -------- Participants helpers --------
  function ensureExpenseParticipants(ex){
    const map = new Map((ex.participants||[]).map(pp => [pp.personId, pp]));
    ex.participants = state.people.map(p=>{
      const prev = map.get(p.id);
      return { personId: p.id, included: prev ? !!prev.included : true, weight: (prev && prev.weight!=null) ? prev.weight : 1 };
    });
  }

  let draftExpense = null;
  function getDraftExpense(){
    if(draftExpense) return deepClone(draftExpense);
    return {
      id: state.editingExpenseId || uid(),
      desc: $("expDesc").value.trim(),
      date: $("expDate").value || "",
      payerId: $("expPayer").value || "",
      amountCents: toCents($("expAmount").value),
      splitType: $("splitType").value,
      participants: []
    };
  }
  function setDraftExpense(ex){ draftExpense = deepClone(ex); }

  function fillExpenseForm(ex){
    state.editingExpenseId = ex ? ex.id : null;

    $("expDesc").value = ex ? (ex.desc || "") : "";
    $("expDate").value = ex ? (ex.date || today()) : today();
    $("splitType").value = ex ? (ex.splitType || "equal") : "equal";
    $("expAmount").value = ex && ex.amountCents!=null ? centsToInput(ex.amountCents) : "";

    renderPayerOptions();
    $("expPayer").value = ex ? (ex.payerId || state.people[0]?.id || "") : (state.people[0]?.id || "");

    draftExpense = deepClone(ex || {
      id: uid(),
      desc: "",
      date: $("expDate").value,
      payerId: $("expPayer").value,
      amountCents: null,
      splitType: $("splitType").value,
      participants: []
    });
    ensureExpenseParticipants(draftExpense);
    renderParticipants();
  }

  function today(){ return new Date().toISOString().slice(0,10); }

  // -------- Render: People --------
  function renderPeople(){
    const box = $("peopleList");
    const empty = $("emptyPeople");
    box.innerHTML = "";

    if(!state.people.length){
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    state.people.forEach(p=>{
      const item = document.createElement("div");
      item.className = "card";
      item.style.margin = "10px 0";
      item.style.background = "rgba(255,255,255,.03)";
      item.innerHTML = `
        <div class="row">
          <div style="flex:1.2">
            <label>Nome</label>
            <input value="${escapeHtml(p.name)}" data-person-name="${p.id}"/>
          </div>
          <div style="flex:.55">
            <button class="btn bad" type="button" data-del-person="${p.id}">Excluir</button>
          </div>
        </div>
      `;
      box.appendChild(item);
    });

    box.querySelectorAll("[data-person-name]").forEach(inp=>{
      inp.addEventListener("input", (e)=>{
        if(state.mode==="view"){ showToast("Somente leitura."); return; }
        const id = e.target.getAttribute("data-person-name");
        const person = state.people.find(x=>x.id===id);
        if(person){
          person.name = e.target.value.trim() || "Sem nome";
          saveLocal();
          renderAll();
        }
      });
    });

    box.querySelectorAll("[data-del-person]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(state.mode==="view"){ showToast("Somente leitura."); return; }
        const id = btn.getAttribute("data-del-person");
        state.people = state.people.filter(p=>p.id!==id);
        state.expenses.forEach(ex=>{
          ex.participants = (ex.participants||[]).filter(pp=>pp.personId!==id);
          if(ex.payerId===id) ex.payerId = state.people[0]?.id || "";
        });
        saveLocal();
        renderAll();
        showToast("Pessoa removida.");
      });
    });
  }

  $("btnAddPerson").addEventListener("click", ()=>{
    if(state.mode==="view"){ showToast("Somente leitura."); return; }
    const name = $("personName").value.trim();
    if(!name) return showToast("Digite um nome.");
    const id = uid();
    state.people.push({id, name});
    $("personName").value = "";

    // adiciona em despesas existentes
    state.expenses.forEach(ex=>{
      ex.participants = ex.participants || [];
      ex.participants.push({personId:id, included:true, weight:1});
    });

    saveLocal();
    renderAll();
    showToast("Pessoa adicionada.");
  });

  // -------- Render: Payer + Participants --------
  function renderPayerOptions(){
    const sel = $("expPayer");
    sel.innerHTML = "";
    if(!state.people.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Adicione pessoas primeiro";
      sel.appendChild(opt);
      return;
    }
    state.people.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
  }

  function renderParticipants(){
    const box = $("participants");
    box.innerHTML = "";

    if(!state.people.length){
      box.innerHTML = `<div class="tiny">Vá em <b>Pessoas</b> e adicione quem participa.</div>`;
      return;
    }

    let ex = getDraftExpense();
    ensureExpenseParticipants(ex);
    setDraftExpense(ex);

    const split = $("splitType").value;

    ex.participants.forEach(pp=>{
      const person = state.people.find(p=>p.id===pp.personId);
      const chip = document.createElement("div");
      chip.className = "member";
      chip.innerHTML = `
        <input type="checkbox" ${pp.included ? "checked":""} data-inc="${pp.personId}"/>
        <span>${escapeHtml(person?.name || "?")}</span>
        ${split==="weights" ? `<input class="w" type="number" min="0" step="1" value="${pp.weight ?? 1}" data-w="${pp.personId}"/>` : ""}
      `;
      box.appendChild(chip);
    });

    box.querySelectorAll("[data-inc]").forEach(ch=>{
      ch.addEventListener("change", ()=>{
        let ex2 = getDraftExpense();
        ensureExpenseParticipants(ex2);
        const pid = ch.getAttribute("data-inc");
        const pp = ex2.participants.find(x=>x.personId===pid);
        if(pp) pp.included = ch.checked;
        setDraftExpense(ex2);
      });
    });

    box.querySelectorAll("[data-w]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        let ex2 = getDraftExpense();
        ensureExpenseParticipants(ex2);
        const pid = inp.getAttribute("data-w");
        const pp = ex2.participants.find(x=>x.personId===pid);
        const n = Number(inp.value);
        pp.weight = Number.isFinite(n) ? Math.max(0, Math.round(n)) : 1;
        setDraftExpense(ex2);
      });
    });
  }

  // -------- Expenses table --------
  function renderExpenses(){
    const tbody = $("expensesTbody");
    const empty = $("emptyExpenses");
    tbody.innerHTML = "";

    if(!state.expenses.length){
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    const peopleMap = new Map(state.people.map(p=>[p.id,p.name]));
    const rows = deepClone(state.expenses).sort((a,b)=> (b.date||"").localeCompare(a.date||""));

    rows.forEach(ex=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="muted">${escapeHtml(ex.date || "—")}</td>
        <td>${escapeHtml(ex.desc || "—")}</td>
        <td>${escapeHtml(peopleMap.get(ex.payerId) || "—")}</td>
        <td><span class="badge">${money(ex.amountCents || 0)}</span></td>
        <td>
          <div class="t-actions">
            <button class="mini" type="button" data-edit="${ex.id}">Editar</button>
            <button class="mini" type="button" data-del="${ex.id}">Excluir</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("[data-edit]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-edit");
        const ex = state.expenses.find(x=>x.id===id);
        if(!ex) return;
        fillExpenseForm(deepClone(ex));
        setTab("despesas");
        showToast("Editando despesa.");
      });
    });

    tbody.querySelectorAll("[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        if(state.mode==="view"){ showToast("Somente leitura."); return; }
        const id = b.getAttribute("data-del");
        state.expenses = state.expenses.filter(x=>x.id!==id);
        if(state.editingExpenseId===id){
          state.editingExpenseId = null;
          draftExpense = null;
          fillExpenseForm(null);
        }
        saveLocal();
        renderAll();
        showToast("Despesa removida.");
      });
    });
  }

  function validateExpense(ex){
    if(!state.people.length) return "Adicione pessoas primeiro.";
    if(!ex.desc) return "Coloque uma descrição.";
    if(!ex.date) return "Escolha a data.";
    if(!ex.payerId) return "Selecione quem pagou.";
    if(ex.amountCents==null || ex.amountCents<=0) return "Valor inválido.";

    const included = (ex.participants||[]).filter(p=>p.included);
    if(!included.length) return "Selecione pelo menos 1 participante.";

    if(ex.splitType==="weights"){
      const sumW = included.reduce((s,p)=> s + (Number(p.weight)||0), 0);
      if(sumW<=0) return "Em pesos, a soma dos pesos precisa ser > 0.";
    }
    return null;
  }

  $("splitType").addEventListener("change", ()=>{
    let ex = getDraftExpense();
    ex.splitType = $("splitType").value;
    ensureExpenseParticipants(ex);
    setDraftExpense(ex);
    renderParticipants();
  });
  ["expDesc","expDate","expPayer","expAmount"].forEach(id=>{
    $(id).addEventListener("input", ()=>{
      let ex = getDraftExpense();
      ensureExpenseParticipants(ex);
      setDraftExpense(ex);
    });
  });

  $("btnClearExp").addEventListener("click", ()=>{
    state.editingExpenseId = null;
    draftExpense = null;
    fillExpenseForm(null);
    showToast("Limpo.");
  });

  $("btnSaveExp").addEventListener("click", ()=>{
    if(state.mode==="view"){ showToast("Somente leitura."); return; }
    let ex = getDraftExpense();
    ensureExpenseParticipants(ex);
    const err = validateExpense(ex);
    if(err) return showToast(err);

    const idx = state.expenses.findIndex(x=>x.id===ex.id);
    if(idx>=0) state.expenses[idx] = ex;
    else state.expenses.push(ex);

    state.editingExpenseId = null;
    draftExpense = null;
    saveLocal();
    fillExpenseForm(null);
    renderAll();
    showToast("Salvo.");
  });

  // -------- Finance calc --------
  function computeBalances(){
    const bal = new Map(state.people.map(p=>[p.id, 0]));

    state.expenses.forEach(ex=>{
      const amount = ex.amountCents || 0;
      bal.set(ex.payerId, (bal.get(ex.payerId)||0) + amount);

      const parts = (ex.participants||[]).filter(p=>p.included);
      if(!parts.length) return;

      if(ex.splitType==="weights"){
        const totalW = parts.reduce((s,p)=> s + (Number(p.weight)||0), 0);
        if(totalW<=0) return;

        // floor + distribuir resto para evitar centavos perdidos
        const shares = parts.map(p=>{
          const w = Number(p.weight)||0;
          return Math.floor(amount * (w/totalW));
        });
        let base = shares.reduce((a,b)=>a+b,0);
        let rem = amount - base;

        // distribui o resto 1 centavo por vez
        for(let i=0; i<parts.length && rem>0; i++){
          shares[i] += 1;
          rem -= 1;
        }

        parts.forEach((p,i)=>{
          bal.set(p.personId, (bal.get(p.personId)||0) - shares[i]);
        });

      } else {
        const n = parts.length;
        const share = Math.floor(amount / n);
        let rem = amount - (share*n);
        parts.forEach((p,i)=>{
          const extra = rem>0 ? 1 : 0;
          if(rem>0) rem--;
          bal.set(p.personId, (bal.get(p.personId)||0) - (share + extra));
        });
      }
    });

    return bal;
  }

  function computeSettlement(bal){
    const creditors = [];
    const debtors = [];
    for(const [pid, cents] of bal.entries()){
      if(cents>0) creditors.push([pid, cents]);
      else if(cents<0) debtors.push([pid, -cents]);
    }
    creditors.sort((a,b)=>b[1]-a[1]);
    debtors.sort((a,b)=>b[1]-a[1]);

    const transfers = [];
    let i=0, j=0;
    while(i<debtors.length && j<creditors.length){
      const dId = debtors[i][0], dAmt = debtors[i][1];
      const cId = creditors[j][0], cAmt = creditors[j][1];
      const x = Math.min(dAmt, cAmt);
      transfers.push({from:dId, to:cId, amount:x});
      debtors[i][1] -= x;
      creditors[j][1] -= x;
      if(debtors[i][1]===0) i++;
      if(creditors[j][1]===0) j++;
    }
    return transfers;
  }

  function renderSummary(){
    const total = state.expenses.reduce((s,e)=> s + (e.amountCents||0), 0);
    $("kpiTotal").textContent = money(total);
    $("kpiN").textContent = String(state.people.length);
    $("kpiE").textContent = String(state.expenses.length);

    const bal = computeBalances();
    const peopleMap = new Map(state.people.map(p=>[p.id,p.name]));

    // balances table
    const items = state.people.map(p=>{
      return {name:p.name, v:(bal.get(p.id)||0)};
    }).sort((a,b)=>b.v-a.v);

    const balancesDiv = $("balances");
    balancesDiv.innerHTML = "";
    if(!items.length){
      balancesDiv.innerHTML = `<div class="tiny">Adicione pessoas e despesas para ver o resumo.</div>`;
    } else {
      const table = document.createElement("table");
      table.innerHTML = `
        <thead><tr><th>Pessoa</th><th>Saldo</th><th>Significado</th></tr></thead>
        <tbody>
          ${items.map(it=>{
            const cls = it.v>0 ? "pos" : (it.v<0 ? "neg" : "zero");
            const interp = it.v>0 ? "Tem a receber" : (it.v<0 ? "Deve pagar" : "Zerado");
            return `
              <tr>
                <td>${escapeHtml(it.name)}</td>
                <td><span class="badge ${cls}">${money(it.v)}</span></td>
                <td class="muted">${interp}</td>
              </tr>`;
          }).join("")}
        </tbody>`;
      balancesDiv.appendChild(table);
    }

    const transfers = computeSettlement(bal);
    const settlementDiv = $("settlement");
    settlementDiv.innerHTML = "";
    if(!transfers.length){
      settlementDiv.innerHTML = `<div class="tiny">Nada a liquidar por enquanto.</div>`;
    } else {
      const box = document.createElement("div");
      box.className = "card";
      box.style.background = "rgba(255,255,255,.03)";
      box.innerHTML = `
        <div class="tiny">
          ${transfers.map(t=>{
            return `<div style="padding:8px 0;border-bottom:1px solid var(--line)">
              <b>${escapeHtml(peopleMap.get(t.from) || "?")}</b> paga <b>${escapeHtml(peopleMap.get(t.to) || "?")}</b>
              <span class="badge" style="margin-left:8px">${money(t.amount)}</span>
            </div>`;
          }).join("")}
        </div>`;
      settlementDiv.appendChild(box);
    }
  }

  // -------- Lock edit mode (somente o necessário) --------
  function applyModeLock(){
    const lock = state.mode === "view";

    // bloquear somente ações de edição
    $("btnAddPerson").disabled = lock;
    $("btnSaveExp").disabled = lock;
    $("btnClearExp").disabled = lock;

    // inputs de edição
    ["personName","expDesc","expDate","expPayer","expAmount","splitType","groupName","currency"].forEach(id=>{
      $(id).disabled = lock;
    });

    // botões da tabela e inputs de nomes
    document.querySelectorAll("[data-del-person],[data-person-name],[data-edit],[data-del],[data-inc],[data-w]").forEach(el=>{
      el.disabled = lock;
    });
  }

  // -------- Buttons top --------
  $("btnShare").addEventListener("click", async ()=>{
    const link = makeShareLink(true); // sempre view no link
    const ok = await copyToClipboard(link);
    if(ok) showToast("Link copiado!");
    else { showToast("Não copiou — copie manualmente."); prompt("Copie o link:", link); }
  });

  $("btnExport").addEventListener("click", ()=>{
    const payload = {groupName:state.groupName, currency:state.currency, people:state.people, expenses:state.expenses};
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = ("racha_" + (state.groupName||"grupo").replace(/\s+/g,"_") + ".json");
    a.click();
    URL.revokeObjectURL(a.href);
    showToast("Exportado.");
  });

  $("btnImport").addEventListener("click", ()=>{
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async ()=>{
      const file = input.files && input.files[0];
      if(!file) return;
      try{
        const txt = await file.text();
        const obj = JSON.parse(txt);
        state.groupName = obj.groupName ?? state.groupName;
        state.currency  = obj.currency ?? state.currency;
        state.people    = Array.isArray(obj.people) ? obj.people : [];
        state.expenses  = Array.isArray(obj.expenses) ? obj.expenses : [];
        state.mode = "edit";
        state.editingExpenseId = null;
        draftExpense = null;
        saveLocal();
        location.hash = "";
        renderAll();
        showToast("Importado.");
      }catch{
        showToast("Arquivo inválido.");
      }
    };
    input.click();
  });

  $("btnReset").addEventListener("click", ()=>{
    if(!confirm("Resetar tudo (pessoas e despesas)?")) return;
    state.groupName = "Meu grupo";
    state.currency = "R$";
    state.mode = "edit";
    state.people = [];
    state.expenses = [];
    state.editingExpenseId = null;
    draftExpense = null;
    location.hash = "";
    saveLocal();
    renderAll();
    showToast("Resetado.");
  });

  $("mode").addEventListener("change", ()=>{
    state.mode = $("mode").value;
    saveLocal();
    renderAll();
    showToast(state.mode==="view" ? "Somente leitura." : "Editável.");
  });

  $("groupName").addEventListener("input", ()=>{
    state.groupName = $("groupName").value.trim() || "Meu grupo";
    saveLocal();
  });
  $("currency").addEventListener("change", ()=>{
    state.currency = $("currency").value;
    saveLocal();
    renderAll();
  });

  // -------- Render all --------
  function renderAll(){
    $("groupName").value = state.groupName || "Meu grupo";
    $("currency").value = state.currency || "R$";
    $("mode").value = state.mode || "edit";

    renderPeople();
    renderPayerOptions();
    if(!$("expDate").value) $("expDate").value = today();

    renderParticipants();
    renderExpenses();
    renderSummary();
    applyModeLock();
  }

  // -------- Init --------
  loadLocal();
  loadFromHashIfAny();

  // Se vazio, cria um exemplo mínimo
  if(!state.people.length && !state.expenses.length){
    state.groupName = "Exemplo (edite ou resete)";
    state.currency = "R$";
    state.people = [
      {id: uid(), name:"Ernandes"},
      {id: uid(), name:"Claumir"},
      {id: uid(), name:"Áurea"}
    ];
    const a = state.people[0].id, b = state.people[1].id, c = state.people[2].id;
    state.expenses = [
      { id: uid(), desc:"Airbnb", date:today(), payerId:a, amountCents:119926, splitType:"equal",
        participants:[{personId:a,included:true,weight:1},{personId:b,included:true,weight:1},{personId:c,included:true,weight:1}] }
    ];
    saveLocal();
  }

  fillExpenseForm(null);
  renderAll();
})();
</script>
</body>
</html>
